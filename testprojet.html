<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Phaser Waves Project + Text Animation</title>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.85.0/dist/phaser.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #b8ffb8;
            overflow: hidden;
            display: flex;
            height: 100vh;
            font-family: Arial, sans-serif;
        }

        #phaser-area {
            width: 70%;
            height: 100vh;
        }

        #right-panel {
            width: 30%;
            background: #ffffffaa;
            backdrop-filter: blur(6px);
            padding: 20px;
            box-sizing: border-box;
        }

        h2 {
            margin-top: 0;
            color: #ff3eb5;
            text-align: center;
        }

        textarea {
            width: 100%;
            height: 120px;
            padding: 10px;
            border-radius: 8px;
            border: 2px solid #ff3eb5;
            font-size: 16px;
            resize: none;
            outline: none;
        }

        button {
            width: 100%;
            margin-top: 15px;
            background: #ff3eb5;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }

        button:hover {
            opacity: 0.85;
        }
    </style>
</head>
<body>

<div id="phaser-area"></div>

<div id="right-panel">
    <h2>Your Text Animation</h2>
    <textarea id="userText" placeholder="Type anything hereâ€¦"></textarea>
    <button onclick="updateTextAnimation()">Animate Text</button>
</div>

<script>
let game;
let textScene;

class MainScene extends Phaser.Scene {
    constructor() {
        super({ key: "main" });
        this.phase = 0;
        this.phaseDuration = 6000;
        this.timeSincePhase = 0;
    }

    preload() {
        this.load.setBaseURL('https://cdn.phaserfiles.com/v385');

        this.load.image('cube', 'assets/sprites/50x50.png');
        this.load.image('spark', 'assets/particles/blue.png');
        this.load.audio('pop', 'assets/audio/SoundEffects/pop.wav');
    }

    create() {
        // Main animation cubes
        const blocks = this.add.group();

        for (let i = 0; i < 108; i++) {
            const child = this.add.image(0, 0, 'cube').setScale(0.3);

            child.setTint(0xff3eb5);

            child.setInteractive();
            child.on('pointerover', () => {
                this.tweens.add({
                    targets: child,
                    scale: 0.5,
                    duration: 150,
                    yoyo: true
                });
            });

            child.on('pointerdown', () => {
                this.sound.play('pop', { volume: 0.5 });

                this.particles.createEmitter({
                    x: child.x,
                    y: child.y,
                    speed: { min: -150, max: 150 },
                    lifespan: 500,
                    scale: { start: 0.5, end: 0 },
                    quantity: 25,
                    tint: 0xff3eb5
                });
            });

            blocks.add(child);
        }

        this.particles = this.add.particles('spark');

        Phaser.Actions.GridAlign(blocks.getChildren(), {
            width: 12,
            height: 9,
            cellWidth: 60,
            cellHeight: 60,
            x: 40,
            y: 30
        });

        this.blocks = blocks;
        this.originalPositions = blocks.getChildren().map(b => ({ x: b.x, y: b.y }));

        // Create secondary scene for text animation
        this.scene.launch("textAnim");
    }

    update(time, delta) {
        this.timeSincePhase += delta;
        if (this.timeSincePhase > this.phaseDuration) {
            this.phase = (this.phase + 1) % 4;
            this.timeSincePhase = 0;
        }

        if (this.input.activePointer.isDown) {
            const mx = this.input.x;
            const my = this.input.y;

            this.blocks.getChildren().forEach(block => {
                const angle = Phaser.Math.Angle.Between(block.x, block.y, mx, my);
                block.x += Math.cos(angle) * 0.6;
                block.y += Math.sin(angle) * 0.6;
            });
        }

        this.animateBlocks(time);
    }

    animateBlocks(time) {
        const blocks = this.blocks.getChildren();
        blocks.forEach((block, i) => {
            const orig = this.originalPositions[i];
            let offset = 0;

            switch (this.phase) {
                case 0:
                    offset = Math.sin(time / 300 + orig.y * 0.12) * 12;
                    break;
                case 1:
                    const dx = orig.x - 400;
                    const dy = orig.y - 300;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    offset = Math.sin(time / 250 + dist * 0.05) * 18;
                    break;
                case 2:
                    offset = Math.sin(time / 220 + (orig.x + orig.y) * 0.06) * 15;
                    break;
                case 3:
                    offset = Math.sin(time / 150 + i) * Phaser.Math.Between(8, 25);
                    break;
            }

            block.x = orig.x + offset;
            block.y = orig.y + offset;
        });
    }
}

class TextAnimScene extends Phaser.Scene {
    constructor() {
        super({ key: "textAnim" });
    }

    create() {
        this.cubes = [];
    }

    animateText(text) {
        this.cubes.forEach(c => c.destroy());
        this.cubes = [];

        let x = 900;
        let y = 100;

        for (let char of text) {
            const cube = this.add.image(x, y, "cube").setScale(0.25);
            cube.setTint(0xff3eb5);

            this.tweens.add({
                targets: cube,
                y: y - 20,
                scale: 0.35,
                duration: 300,
                yoyo: true,
                repeat: -1,
                ease: "sine.inout",
                delay: Math.random() * 400
            });

            this.cubes.push(cube);
            x += 45;

            if (x > 1150) {
                x = 900;
                y += 60;
            }
        }
    }
}

game = new Phaser.Game({
    type: Phaser.AUTO,
    width: window.innerWidth * 0.7,
    height: window.innerHeight,
    backgroundColor: '#b8ffb8',
    parent: 'phaser-area',
    scene: [MainScene, TextAnimScene]
});

// Function called from HTML
function updateTextAnimation() {
    const text = document.getElementById("userText").value;
    const scene = game.scene.keys["textAnim"];
    scene.animateText(text);
}
</script>

</body>
</html>
