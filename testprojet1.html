<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <title>Phaser Waves + Text Generator</title>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.85.0/dist/phaser.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #b8ffb8;
            display: flex;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        /* Zone Phaser à gauche */
        #phaser-example {
            width: 70vw;
            height: 100vh;
        }

        /* Zone interface à droite */
        #right-panel {
            width: 30vw;
            height: 100vh;
            background: #ffffffaa;
            padding: 20px;
            box-sizing: border-box;
            backdrop-filter: blur(5px);
        }

        #right-panel h2 {
            margin-top: 0;
            color: #ff3eb5;
            font-size: 28px;
            text-align: center;
        }

        #text-input {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            margin-bottom: 15px;
            border: 2px solid #ff3eb5;
            border-radius: 10px;
            outline: none;
        }

        #generate-btn {
            width: 100%;
            padding: 12px;
            background: #ff3eb5;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
        }

        #generate-btn:hover {
            background: #ff1ea0;
        }

        #phaser-text {
            margin-top: 30px;
            height: 60vh;
            border: 2px dashed #ff3eb5;
            border-radius: 10px;
            padding: 10px;
            color: #ff3eb5;
        }
    </style>
</head>

<body>

    <div id="phaser-example"></div>

    <div id="right-panel">
        <h2>Créer une animation avec ton texte</h2>
        <input id="text-input" type="text" placeholder="Écris un mot ou une phrase…">
        <button id="generate-btn">Générer l’animation</button>

        <div id="phaser-text"></div>
    </div>

    <script>
        class Example extends Phaser.Scene {
            constructor() {
                // give the scene a key — avoids some subtle lifecycle issues
                super({ key: 'Example' });

                this.phase = 0;
                this.phaseDuration = 6000;
                this.timeSincePhase = 0;
            }

            preload() {
                // The paths below MUST match the folders you create on GitHub
                this.load.image('square', 'assets/sprites/50x50.png');
                this.load.image('circle', 'assets/sprites/blue_ball.png');
                this.load.image('diamond', 'assets/sprites/diamond.png');

                this.load.image('spark', 'assets/particles/blue.png');
                this.load.audio('pop', 'assets/audio/SoundEffects/pop.wav');
            }

            create() {
                const shapes = ["square", "circle", "diamond"];
                const blocks = this.add.group();

                // use the scene scale values which are more robust than sys.game.config in some cases
                const gameWidth = this.scale.width;
                const gameHeight = this.scale.height;

                for (let i = 0; i < 108; i++) {
                    const shape = shapes[i % shapes.length];
                    const child = this.add.image(0, 0, shape).setScale(0.3);

                    child.setTint(0xff3eb5); // rose

                    child.setInteractive();
                    child.on("pointerover", () => {
                        this.tweens.add({
                            targets: child,
                            scale: 0.5,
                            duration: 150,
                            yoyo: true
                        });
                    });

                    child.on("pointerdown", () => {
                        // play sound on user interaction (click)
                        if (this.sound && this.sound.exists('pop')) {
                            try {
                                this.sound.play('pop');
                            } catch (e) {
                                // some browsers block autoplay until user gesture; click should allow playback
                                console.warn('Could not play sound:', e);
                            }
                        }

                        this.particles.createEmitter({
                            x: child.x,
                            y: child.y,
                            speed: { min: -150, max: 150 },
                            lifespan: 500,
                            scale: { start: 0.5, end: 0 },
                            quantity: 25,
                            tint: 0xff3eb5
                        });
                    });

                    blocks.add(child);
                }

                this.particles = this.add.particles("spark");

                Phaser.Actions.GridAlign(blocks.getChildren(), {
                    width: 12,
                    height: 9,
                    cellWidth: 60,
                    cellHeight: 60,
                    x: (gameWidth - (12 * 60)) / 2 + 30,
                    y: (gameHeight - (9 * 60)) / 2 + 30
                });

                this.blocks = blocks;
                this.originalPositions = blocks.getChildren().map(b => ({ x: b.x, y: b.y }));

                // TEXT ANIMATION ZONE
                this.createTextEngine();
            }

            update(time, delta) {
                this.timeSincePhase += delta;
                if (this.timeSincePhase > this.phaseDuration) {
                    this.phase = (this.phase + 1) % 4;
                    this.timeSincePhase = 0;
                }

                // Use activePointer.x / y (this.input.x / this.input.y do not exist)
                if (this.input.activePointer.isDown) {
                    const mx = this.input.activePointer.x;
                    const my = this.input.activePointer.y;

                    this.blocks.getChildren().forEach(block => {
                        const angle = Phaser.Math.Angle.Between(block.x, block.y, mx, my);
                        block.x += Math.cos(angle) * 0.6;
                        block.y += Math.sin(angle) * 0.6;
                    });
                }

                this.animateBlocks(time);
            }

            animateBlocks(time) {
                const blocks = this.blocks.getChildren();
                const centerX = this.scale.width / 2;
                const centerY = this.scale.height / 2;

                blocks.forEach((block, i) => {
                    const orig = this.originalPositions[i];
                    let offset = 0;

                    switch (this.phase) {
                        case 0:
                            offset = Math.sin(time / 300 + orig.y * 0.12) * 12;
                            block.x = orig.x + offset;
                            block.y = orig.y;
                            break;
                        case 1:
                            const dx1 = orig.x - centerX;
                            const dy1 = orig.y - centerY;
                            const dist = Math.sqrt(dx1 * dx1 + dy1 * dy1);
                            offset = Math.sin(time / 250 + dist * 0.05) * 18;
                            block.x = orig.x + dx1 * 0.03 * Math.sin(time / 500);
                            block.y = orig.y + offset;
                            break;
                        case 2:
                            offset = Math.sin(time / 220 + (orig.x + orig.y) * 0.06) * 15;
                            block.x = orig.x + offset;
                            block.y = orig.y + offset * 0.5;
                            break;
                        case 3:
                            // For consistent animation, use a deterministic function per index
                            offset = Math.sin(time / 150 + i * 0.5) * (8 + (i % 18));
                            block.x = orig.x + offset * 0.8;
                            block.y = orig.y + offset;
                            break;
                    }
                });
            }

            /** TEXT ENGINE **/
            createTextEngine() {
                const input = document.getElementById("text-input");
                const button = document.getElementById("generate-btn");

                button.addEventListener("click", () => {
                    this.generateAnimatedText(input.value.toUpperCase());
                });

                // generate initial text
                this.generateAnimatedText("PHASER");
            }

            generateAnimatedText(text) {
                if (!text) return;

                const startX = this.scale.width * 0.75;
                const startY = 100;

                if (this.letters) {
                    // kill any tweens tied to previous letters before destroying them
                    this.letters.forEach(l => {
                        try { this.tweens.killTweensOf(l); } catch (e) { }
                        try { l.destroy(); } catch (e) { }
                    });
                }

                this.letters = [];

                [...text].forEach((char, i) => {
                    const letter = this.add.text(startX, startY + i * 40, char, {
                        fontFamily: 'Arial',
                        fontSize: '40px',
                        color: '#ff3eb5'
                    }).setOrigin(0.5);

                    this.letters.push(letter);

                    this.tweens.add({
                        targets: letter,
                        x: startX + 30,
                        angle: 10,
                        yoyo: true,
                        repeat: -1,
                        duration: 800 + i * 30,
                        ease: "sine.inout"
                    });
                });

                const phaserTextDiv = document.getElementById("phaser-text");
                phaserTextDiv.textContent = `Texte affiché : ${text}`;
            }
        }

        const config = {
            type: Phaser.AUTO,
            width: Math.floor(window.innerWidth * 0.70),
            height: Math.floor(window.innerHeight),
            backgroundColor: '#b8ffb8',
            parent: 'phaser-example',
            scene: Example
        };

        new Phaser.Game(config);
    </script>

</body>

</html>
