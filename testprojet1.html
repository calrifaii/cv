<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Phaser Waves + Text Generator</title>

    <script src="https://cdn.jsdelivr.net/npm/phaser@3.85.0/dist/phaser.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            background: #b8ffb8;
            display: flex;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }

        /* Zone Phaser à gauche */
        #phaser-example {
            width: 70vw;
            height: 100vh;
        }

        /* Zone interface à droite */
        #right-panel {
            width: 30vw;
            height: 100vh;
            background: #ffffffaa;
            padding: 20px;
            box-sizing: border-box;
            backdrop-filter: blur(5px);
        }

        #right-panel h2 {
            margin-top: 0;
            color: #ff3eb5;
            font-size: 28px;
            text-align: center;
        }

        #text-input {
            width: 100%;
            padding: 12px;
            font-size: 18px;
            margin-bottom: 15px;
            border: 2px solid #ff3eb5;
            border-radius: 10px;
            outline: none;
        }

        #generate-btn {
            width: 100%;
            padding: 12px;
            background: #ff3eb5;
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 20px;
            cursor: pointer;
        }

        #generate-btn:hover {
            background: #ff1ea0;
        }

        #phaser-text {
            margin-top: 30px;
            height: 60vh;
            border: 2px dashed #ff3eb5;
            border-radius: 10px;
            padding: 10px;
            color: #ff3eb5;
        }
    </style>
</head>
<body>

<div id="phaser-example"></div>

<div id="right-panel">
    <h2>Créer une animation avec ton texte</h2>
    <input id="text-input" type="text" placeholder="Écris un mot ou une phrase…">
    <button id="generate-btn">Générer l’animation</button>

    <div id="phaser-text"></div>
</div>

<script>
class Example extends Phaser.Scene
{
    constructor ()
    {
        super();
        this.phase = 0;
        this.phaseDuration = 6000;
        this.timeSincePhase = 0;
        this.particles = null; 
    }

    preload ()
    {
        // L'URL de base est maintenue pour éviter le CORS
        this.load.setBaseURL('https://raw.githubusercontent.com/phaserjs/phaser/v3.85.0/assets');

        // Correction des chemins pour éviter les erreurs 404
        this.load.image('square', 'images/wobble.png');
        this.load.image('circle', 'images/bubble256.png'); 
        this.load.image('diamond', 'images/diamond.png');

        this.load.image('spark', 'particles/blue.png'); 
        // Changement de l'extension et du nom de fichier audio
        this.load.audio('pop', 'audio/squit.mp3'); 
    }

    create ()
    {
        // Mise à jour des clés d'assets ici pour correspondre aux nouveaux assets chargés
        const shapes = ["square", "circle", "diamond"];
        const blocks = this.add.group();

        this.particles = this.add.particles('spark'); 

        for (let i = 0; i < 108; i++) {
            const shape = shapes[i % shapes.length];
            const child = this.add.image(0, 0, shape).setScale(0.3);

            child.setTint(0xff3eb5); // rose

            child.setInteractive();
            child.on("pointerover", () => {
                this.tweens.add({
                    targets: child,
                    scale: 0.5,
                    duration: 150,
                    yoyo: true
                });
            });

            child.on("pointerdown", () => {
                // Le son fonctionne désormais avec le nouvel asset mp3
                this.sound.play('pop'); 

                this.particles.createEmitter({
                    x: child.x,
                    y: child.y,
                    speed: { min: -150, max: 150 },
                    lifespan: 500,
                    scale: { start: 0.5, end: 0 },
                    quantity: 25,
                    tint: 0xff3eb5
                });
            });

            blocks.add(child);
        }

        Phaser.Actions.GridAlign(blocks.getChildren(), {
            width: 12,
            height: 9,
            cellWidth: 60,
            cellHeight: 60,
            x: 40,
            y: 30
        });

        this.blocks = blocks;
        this.originalPositions = blocks.getChildren().map(b => ({ x: b.x, y: b.y }));

        // TEXT ANIMATION ZONE
        this.createTextEngine();
    }

    update(time, delta)
    {
        this.timeSincePhase += delta;
        if (this.timeSincePhase > this.phaseDuration) {
            this.phase = (this.phase + 1) % 4;
            this.timeSincePhase = 0;
        }

        if (this.input.activePointer.isDown) {
            const mx = this.input.x;
            const my = this.input.y;

            this.blocks.getChildren().forEach(block => {
                const angle = Phaser.Math.Angle.Between(block.x, block.y, mx, my);
                block.x += Math.cos(angle) * 0.6;
                block.y += Math.sin(angle) * 0.6;
            });
        }

        this.animateBlocks(time);
    }

    animateBlocks(time)
    {
        const blocks = this.blocks.getChildren();

        blocks.forEach((block, i) => {
            const orig = this.originalPositions[i];
            let offset = 0;

            switch (this.phase) {
                case 0:
                    // Vague verticale
                    offset = Math.sin(time / 300 + orig.y * 0.12) * 12;
                    break;
                case 1:
                    // Vague radiale
                    const dx = orig.x - 400;
                    const dy = orig.y - 300;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    offset = Math.sin(time / 250 + dist * 0.05) * 18;
                    break;
                case 2:
                    // Vague diagonale
                    offset = Math.sin(time / 220 + (orig.x + orig.y) * 0.06) * 15;
                    break;
                case 3:
                    // Tremblement aléatoire
                    offset = Math.sin(time / 150 + i) * Phaser.Math.Between(8, 25);
                    break;
            }

            block.x = orig.x + offset;
            block.y = orig.y + offset;
        });
    }

    /** TEXT ENGINE **/
    createTextEngine() {
        const input = document.getElementById("text-input");
        const button = document.getElementById("generate-btn");

        button.addEventListener("click", () => {
            this.generateAnimatedText(input.value.toUpperCase());
        });
    }

    generateAnimatedText(text) {
        if (!text) return;

        const startX = this.sys.game.config.width * 0.5; // Centre horizontal du canvas Phaser
        const startY = 100;

        // Suppression des lettres précédentes
        if (this.letters) {
            this.letters.forEach(l => l.destroy());
        }

        this.letters = [];

        [...text].forEach((char, i) => {
            const letter = this.add.text(startX, startY + i * 40, char, {
                fontFamily: 'Arial',
                fontSize: '40px',
                color: '#ff3eb5'
            }).setOrigin(0.5);

            this.letters.push(letter);

            this.tweens.add({
                targets: letter,
                x: startX + 30,
                angle: 10,
                yoyo: true,
                repeat: -1,
                duration: 800 + i * 30,
                ease: "sine.inout"
            });
        });
    }
}

const config = {
    type: Phaser.AUTO,
    width: window.innerWidth * 0.70,
    height: window.innerHeight,
    backgroundColor: '#b8ffb8',
    parent: 'phaser-example',
    scene: Example
};

// Gestion de la taille de la fenêtre
let game = null;
window.addEventListener('resize', () => {
    config.width = window.innerWidth * 0.70;
    config.height = window.innerHeight;
    if (game && game.isBooted) {
        game.scale.resize(config.width, config.height);
    }
});

game = new Phaser.Game(config);
</script>

</body>
</html>
